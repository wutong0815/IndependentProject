<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.springbootmodule.mapper.UserRepository">

    <select id="findByUsername" resultType="com.example.springbootmodule.domain.User">
        SELECT * FROM sys_user
        WHERE username = #{username} AND deleted = 0
    </select>

    <select id="findByEmail" resultType="com.example.springbootmodule.domain.User">
        SELECT * FROM  sys_user
        WHERE email = #{email} AND deleted = 0
    </select>

    <select id="selectUserPage" resultType="com.example.springbootmodule.domain.User">
        SELECT u.* FROM sys_user u
        LEFT JOIN user_profile up ON u.id = up.user_id
        WHERE u.deleted = 0
        <if test="query.username != null and query.username != ''">
            AND u.username LIKE CONCAT('%', #{query.username}, '%')
        </if>
        <if test="query.email != null and query.email != ''">
            AND u.email LIKE CONCAT('%', #{query.email}, '%')
        </if>
        <if test="query.phone != null and query.phone != ''">
            AND u.phone LIKE CONCAT('%', #{query.phone}, '%')
        </if>
        <if test="query.nickname != null and query.nickname != ''">
            AND u.nickname LIKE CONCAT('%', #{query.nickname}, '%')
        </if>
        <if test="query.gender != null">
            AND u.gender = #{query.gender}
        </if>
        <if test="query.status != null">
            AND u.status = #{query.status}
        </if>
        <if test="query.realName != null and query.realName != ''">
            AND up.real_name LIKE CONCAT('%', #{query.realName}, '%')
        </if>
        ORDER BY u.create_time DESC
    </select>

    <update id="updateLoginInfo">
        UPDATE sys_user
        SET last_login_time = #{loginTime}, last_login_ip = #{loginIp}, update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

</mapper>